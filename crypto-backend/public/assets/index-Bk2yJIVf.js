import*as l from"net";import*as y from"tls";import{once as m}from"events";import{A as x}from"./index-BOx5C7cf.js";import"http";import"https";function g(s){return typeof s=="string"?/^https:?$/i.test(s):!1}class H extends x{constructor(t,e){super(e),this.proxy=typeof t=="string"?new URL(t):t,this.proxyHeaders=e?.headers??{};const o=(this.proxy.hostname||this.proxy.host).replace(/^\[|\]$/g,""),c=this.proxy.port?parseInt(this.proxy.port,10):this.secureProxy?443:80;this.connectOpts={...e?P(e,"headers"):null,host:o,port:c}}get secureProxy(){return g(this.proxy.protocol)}async connect(t,e){const{proxy:o}=this,c=e.secureEndpoint?"https:":"http:",f=t.getHeader("host")||"localhost",d=`${c}//${f}`,p=new URL(t.path,d);e.port!==80&&(p.port=String(e.port)),t.path=String(p),t._header=null;const n=typeof this.proxyHeaders=="function"?this.proxyHeaders():{...this.proxyHeaders};if(o.username||o.password){const i=`${decodeURIComponent(o.username)}:${decodeURIComponent(o.password)}`;n["Proxy-Authorization"]=`Basic ${Buffer.from(i).toString("base64")}`}n["Proxy-Connection"]||(n["Proxy-Connection"]=this.keepAlive?"Keep-Alive":"close");for(const i of Object.keys(n)){const u=n[i];u&&t.setHeader(i,u)}let r;this.secureProxy?r=y.connect(this.connectOpts):r=l.connect(this.connectOpts);let a,h;return t._implicitHeader(),t.outputData&&t.outputData.length>0&&(a=t.outputData[0].data,h=a.indexOf(`\r
\r
`)+4,t.outputData[0].data=t._header+a.substring(h)),await m(r,"connect"),r}}H.protocols=["http","https"];function P(s,...t){const e={};let o;for(o in s)t.includes(o)||(e[o]=s[o]);return e}export{H as HttpProxyAgent};
