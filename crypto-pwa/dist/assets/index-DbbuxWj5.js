import*as x from"net";import*as H from"tls";import O from"assert";import{A as T}from"./index-BOx5C7cf.js";import"http";import"https";function I(t){return new Promise((n,e)=>{let r=0;const a=[];function o(){const i=t.read();i?p(i):t.once("readable",o)}function c(){t.removeListener("end",u),t.removeListener("error",l),t.removeListener("close",h),t.removeListener("readable",o)}function h(i){}function u(){}function l(i){c(),e(i)}function p(i){a.push(i),r+=i.length;const f=Buffer.concat(a,r);if(f.indexOf(`\r
\r
`)===-1){o();return}const $=f.toString("ascii").split(`\r
`),C=$.shift();if(!C)throw new Error("No header received");const g=C.split(" "),b=+g[1],A=g.slice(2).join(" "),y={};for(const d of $){if(!d)continue;const P=d.indexOf(":");if(P===-1)throw new Error(`Invalid header: "${d}"`);const w=d.slice(0,P).toLowerCase(),v=d.slice(P+1).trimStart(),m=y[w];typeof m=="string"?y[w]=[m,v]:Array.isArray(m)?m.push(v):y[w]=v}c(),n({connect:{statusCode:b,statusText:A,headers:y},buffered:f})}t.on("error",l),t.on("close",h),t.on("end",u),o()})}class S extends T{constructor(n,e){super(e),this.options={path:void 0},this.proxy=typeof n=="string"?new URL(n):n,this.proxyHeaders=e?.headers??{};const r=(this.proxy.hostname||this.proxy.host).replace(/^\[|\]$/g,""),a=this.proxy.port?parseInt(this.proxy.port,10):this.secureProxy?443:80;this.connectOpts={ALPNProtocols:["http/1.1"],...e?L(e,"headers"):null,host:r,port:a}}get secureProxy(){return N(this.proxy.protocol)}async connect(n,e){const{proxy:r,secureProxy:a}=this;if(!e.host)throw new TypeError('No "host" provided');let o;a?o=H.connect(this.connectOpts):o=x.connect(this.connectOpts);const c=typeof this.proxyHeaders=="function"?this.proxyHeaders():{...this.proxyHeaders},h=x.isIPv6(e.host)?`[${e.host}]`:e.host;let u=`CONNECT ${h}:${e.port} HTTP/1.1\r
`;if(r.username||r.password){const s=`${decodeURIComponent(r.username)}:${decodeURIComponent(r.password)}`;c["Proxy-Authorization"]=`Basic ${Buffer.from(s).toString("base64")}`}c.Host=`${h}:${e.port}`,c["Proxy-Connection"]||(c["Proxy-Connection"]=this.keepAlive?"Keep-Alive":"close");for(const s of Object.keys(c))u+=`${s}: ${c[s]}\r
`;const l=I(o);o.write(`${u}\r
`);const{connect:p,buffered:i}=await l;if(n.emit("proxyConnect",p),this.emit("proxyConnect",p,n),p.statusCode===200){if(n.once("socket",E),e.secureEndpoint){const s=e.servername||e.host;return H.connect({...L(e,"host","path","port"),socket:o,servername:x.isIP(s)?void 0:s})}return o}o.destroy();const f=new x.Socket({writable:!1});return f.readable=!0,n.once("socket",s=>{O(s.listenerCount("data")>0),s.push(i),s.push(null)}),f}}S.protocols=["http","https"];function E(t){t.resume()}function N(t){return typeof t=="string"?/^https:?$/i.test(t):!1}function L(t,...n){const e={};let r;for(r in t)n.includes(r)||(e[r]=t[r]);return e}export{S as HttpsProxyAgent};
