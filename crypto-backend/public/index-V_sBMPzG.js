import C from"node:http";import re from"node:https";import A from"node:zlib";import S,{PassThrough as N,pipeline as U}from"node:stream";import{Buffer as d}from"node:buffer";import{types as F,deprecate as W,promisify as te}from"node:util";import{format as ne}from"node:url";import{isIP as oe}from"node:net";class D extends Error{constructor(e,t){super(e),Error.captureStackTrace(this,this.constructor),this.type=t}get name(){return this.constructor.name}get[Symbol.toStringTag](){return this.constructor.name}}class T extends D{constructor(e,t,o){super(e,t),o&&(this.code=this.errno=o.code,this.erroredSysCall=o.syscall)}}const I=Symbol.toStringTag,_=r=>typeof r=="object"&&typeof r.append=="function"&&typeof r.delete=="function"&&typeof r.get=="function"&&typeof r.getAll=="function"&&typeof r.has=="function"&&typeof r.set=="function"&&typeof r.sort=="function"&&r[I]==="URLSearchParams",M=r=>r&&typeof r=="object"&&typeof r.arrayBuffer=="function"&&typeof r.type=="string"&&typeof r.stream=="function"&&typeof r.constructor=="function"&&/^(Blob|File)$/.test(r[I]),se=r=>typeof r=="object"&&(r[I]==="AbortSignal"||r[I]==="EventTarget"),ie=(r,e)=>{const t=new URL(e).hostname,o=new URL(r).hostname;return t===o||t.endsWith(`.${o}`)},ae=(r,e)=>{const t=new URL(e).protocol,o=new URL(r).protocol;return t===o},ce=te(S.pipeline),g=Symbol("Body internals");class k{constructor(e,{size:t=0}={}){let o=null;e===null?e=null:_(e)?e=d.from(e.toString()):M(e)||d.isBuffer(e)||(F.isAnyArrayBuffer(e)?e=d.from(e):ArrayBuffer.isView(e)?e=d.from(e.buffer,e.byteOffset,e.byteLength):e instanceof S||(e=d.from(String(e))));let n=e;d.isBuffer(e)?n=S.Readable.from(e):M(e)&&(n=S.Readable.from(e.stream())),this[g]={body:e,stream:n,boundary:o,disturbed:!1,error:null},this.size=t,e instanceof S&&e.on("error",s=>{const a=s instanceof D?s:new T(`Invalid response body while trying to fetch ${this.url}: ${s.message}`,"system",s);this[g].error=a})}get body(){return this[g].stream}get bodyUsed(){return this[g].disturbed}async arrayBuffer(){const{buffer:e,byteOffset:t,byteLength:o}=await V(this);return e.slice(t,t+o)}async blob(){const e=this.headers&&this.headers.get("content-type")||this[g].body&&this[g].body.type||"",t=await this.arrayBuffer();return new Blob([t],{type:e})}async json(){const e=await this.text();return JSON.parse(e)}async text(){const e=await V(this);return new TextDecoder().decode(e)}buffer(){return V(this)}}k.prototype.buffer=W(k.prototype.buffer,"Please use 'response.arrayBuffer()' instead of 'response.buffer()'","node-fetch#buffer");Object.defineProperties(k.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0},data:{get:W(()=>{},"data doesn't exist, use json(), text(), arrayBuffer(), or body instead","https://github.com/node-fetch/node-fetch/issues/1000 (response)")}});async function V(r){if(r[g].disturbed)throw new TypeError(`body used already for: ${r.url}`);if(r[g].disturbed=!0,r[g].error)throw r[g].error;const{body:e}=r;if(e===null)return d.alloc(0);if(!(e instanceof S))return d.alloc(0);const t=[];let o=0;try{for await(const n of e){if(r.size>0&&o+n.length>r.size){const s=new T(`content size at ${r.url} over limit: ${r.size}`,"max-size");throw e.destroy(s),s}o+=n.length,t.push(n)}}catch(n){throw n instanceof D?n:new T(`Invalid response body while trying to fetch ${r.url}: ${n.message}`,"system",n)}if(e.readableEnded===!0||e._readableState.ended===!0)try{return t.every(n=>typeof n=="string")?d.from(t.join("")):d.concat(t,o)}catch(n){throw new T(`Could not create Buffer from response body for ${r.url}: ${n.message}`,"system",n)}else throw new T(`Premature close of server response while trying to fetch ${r.url}`)}const K=(r,e)=>{let t,o,{body:n}=r[g];if(r.bodyUsed)throw new Error("cannot clone body after it is used");return n instanceof S&&typeof n.getBoundary!="function"&&(t=new N({highWaterMark:e}),o=new N({highWaterMark:e}),n.pipe(t),n.pipe(o),r[g].stream=t,n=o),n},ue=W(r=>r.getBoundary(),"form-data doesn't follow the spec and requires special treatment. Use alternative package","https://github.com/node-fetch/node-fetch/issues/1167"),Q=(r,e)=>r===null?null:typeof r=="string"?"text/plain;charset=UTF-8":_(r)?"application/x-www-form-urlencoded;charset=UTF-8":M(r)?r.type||null:d.isBuffer(r)||F.isAnyArrayBuffer(r)||ArrayBuffer.isView(r)?null:r&&typeof r.getBoundary=="function"?`multipart/form-data;boundary=${ue(r)}`:r instanceof S?null:"text/plain;charset=UTF-8",fe=r=>{const{body:e}=r[g];return e===null?0:M(e)?e.size:d.isBuffer(e)?e.length:e&&typeof e.getLengthSync=="function"&&e.hasKnownLength&&e.hasKnownLength()?e.getLengthSync():null},le=async(r,{body:e})=>{e===null?r.end():await ce(e,r)},O=typeof C.validateHeaderName=="function"?C.validateHeaderName:r=>{if(!/^[\^`\-\w!#$%&'*+.|~]+$/.test(r)){const e=new TypeError(`Header name must be a valid HTTP token [${r}]`);throw Object.defineProperty(e,"code",{value:"ERR_INVALID_HTTP_TOKEN"}),e}},G=typeof C.validateHeaderValue=="function"?C.validateHeaderValue:(r,e)=>{if(/[^\t\u0020-\u007E\u0080-\u00FF]/.test(e)){const t=new TypeError(`Invalid character in header content ["${r}"]`);throw Object.defineProperty(t,"code",{value:"ERR_INVALID_CHAR"}),t}};class E extends URLSearchParams{constructor(e){let t=[];if(e instanceof E){const o=e.raw();for(const[n,s]of Object.entries(o))t.push(...s.map(a=>[n,a]))}else if(e!=null)if(typeof e=="object"&&!F.isBoxedPrimitive(e)){const o=e[Symbol.iterator];if(o==null)t.push(...Object.entries(e));else{if(typeof o!="function")throw new TypeError("Header pairs must be iterable");t=[...e].map(n=>{if(typeof n!="object"||F.isBoxedPrimitive(n))throw new TypeError("Each header pair must be an iterable object");return[...n]}).map(n=>{if(n.length!==2)throw new TypeError("Each header pair must be a name/value tuple");return[...n]})}}else throw new TypeError("Failed to construct 'Headers': The provided value is not of type '(sequence<sequence<ByteString>> or record<ByteString, ByteString>)");return t=t.length>0?t.map(([o,n])=>(O(o),G(o,String(n)),[String(o).toLowerCase(),String(n)])):void 0,super(t),new Proxy(this,{get(o,n,s){switch(n){case"append":case"set":return(a,u)=>(O(a),G(a,String(u)),URLSearchParams.prototype[n].call(o,String(a).toLowerCase(),String(u)));case"delete":case"has":case"getAll":return a=>(O(a),URLSearchParams.prototype[n].call(o,String(a).toLowerCase()));case"keys":return()=>(o.sort(),new Set(URLSearchParams.prototype.keys.call(o)).keys());default:return Reflect.get(o,n,s)}}})}get[Symbol.toStringTag](){return this.constructor.name}toString(){return Object.prototype.toString.call(this)}get(e){const t=this.getAll(e);if(t.length===0)return null;let o=t.join(", ");return/^content-encoding$/i.test(e)&&(o=o.toLowerCase()),o}forEach(e,t=void 0){for(const o of this.keys())Reflect.apply(e,t,[this.get(o),o,this])}*values(){for(const e of this.keys())yield this.get(e)}*entries(){for(const e of this.keys())yield[e,this.get(e)]}[Symbol.iterator](){return this.entries()}raw(){return[...this.keys()].reduce((e,t)=>(e[t]=this.getAll(t),e),{})}[Symbol.for("nodejs.util.inspect.custom")](){return[...this.keys()].reduce((e,t)=>{const o=this.getAll(t);return t==="host"?e[t]=o[0]:e[t]=o.length>1?o:o[0],e},{})}}Object.defineProperties(E.prototype,["get","entries","forEach","values"].reduce((r,e)=>(r[e]={enumerable:!0},r),{}));function he(r=[]){return new E(r.reduce((e,t,o,n)=>(o%2===0&&e.push(n.slice(o,o+2)),e),[]).filter(([e,t])=>{try{return O(e),G(e,String(t)),!0}catch{return!1}}))}const de=new Set([301,302,303,307,308]),X=r=>de.has(r),w=Symbol("Response internals");class m extends k{constructor(e=null,t={}){super(e,t);const o=t.status!=null?t.status:200,n=new E(t.headers);if(e!==null&&!n.has("Content-Type")){const s=Q(e);s&&n.append("Content-Type",s)}this[w]={type:"default",url:t.url,status:o,statusText:t.statusText||"",headers:n,counter:t.counter,highWaterMark:t.highWaterMark}}get type(){return this[w].type}get url(){return this[w].url||""}get status(){return this[w].status}get ok(){return this[w].status>=200&&this[w].status<300}get redirected(){return this[w].counter>0}get statusText(){return this[w].statusText}get headers(){return this[w].headers}get highWaterMark(){return this[w].highWaterMark}clone(){return new m(K(this,this.highWaterMark),{type:this.type,url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok,redirected:this.redirected,size:this.size,highWaterMark:this.highWaterMark})}static redirect(e,t=302){if(!X(t))throw new RangeError('Failed to execute "redirect" on "response": Invalid status code');return new m(null,{headers:{location:new URL(e).toString()},status:t})}static error(){const e=new m(null,{status:0,statusText:""});return e[w].type="error",e}static json(e=void 0,t={}){const o=JSON.stringify(e);if(o===void 0)throw new TypeError("data is not JSON serializable");const n=new E(t&&t.headers);return n.has("content-type")||n.set("content-type","application/json"),new m(o,{...t,headers:n})}get[Symbol.toStringTag](){return"Response"}}Object.defineProperties(m.prototype,{type:{enumerable:!0},url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},redirected:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}});const pe=r=>{if(r.search)return r.search;const e=r.href.length-1,t=r.hash||(r.href[e]==="#"?"#":"");return r.href[e-t.length]==="?"?"?":""};function Z(r,e=!1){return r==null||(r=new URL(r),/^(about|blob|data):$/.test(r.protocol))?"no-referrer":(r.username="",r.password="",r.hash="",e&&(r.pathname="",r.search=""),r)}const j=new Set(["","no-referrer","no-referrer-when-downgrade","same-origin","origin","strict-origin","origin-when-cross-origin","strict-origin-when-cross-origin","unsafe-url"]),ge="strict-origin-when-cross-origin";function ye(r){if(!j.has(r))throw new TypeError(`Invalid referrerPolicy: ${r}`);return r}function me(r){if(/^(http|ws)s:$/.test(r.protocol))return!0;const e=r.host.replace(/(^\[)|(]$)/g,""),t=oe(e);return t===4&&/^127\./.test(e)||t===6&&/^(((0+:){7})|(::(0+:){0,6}))0*1$/.test(e)?!0:r.host==="localhost"||r.host.endsWith(".localhost")?!1:r.protocol==="file:"}function B(r){return/^about:(blank|srcdoc)$/.test(r)||r.protocol==="data:"||/^(blob|filesystem):$/.test(r.protocol)?!0:me(r)}function we(r,{referrerURLCallback:e,referrerOriginCallback:t}={}){if(r.referrer==="no-referrer"||r.referrerPolicy==="")return null;const o=r.referrerPolicy;if(r.referrer==="about:client")return"no-referrer";const n=r.referrer;let s=Z(n),a=Z(n,!0);s.toString().length>4096&&(s=a),e&&(s=e(s)),t&&(a=t(a));const u=new URL(r.url);switch(o){case"no-referrer":return"no-referrer";case"origin":return a;case"unsafe-url":return s;case"strict-origin":return B(s)&&!B(u)?"no-referrer":a.toString();case"strict-origin-when-cross-origin":return s.origin===u.origin?s:B(s)&&!B(u)?"no-referrer":a;case"same-origin":return s.origin===u.origin?s:"no-referrer";case"origin-when-cross-origin":return s.origin===u.origin?s:a;case"no-referrer-when-downgrade":return B(s)&&!B(u)?"no-referrer":s;default:throw new TypeError(`Invalid referrerPolicy: ${o}`)}}function be(r){const e=(r.get("referrer-policy")||"").split(/[,\s]+/);let t="";for(const o of e)o&&j.has(o)&&(t=o);return t}const l=Symbol("Request internals"),x=r=>typeof r=="object"&&typeof r[l]=="object",Te=W(()=>{},".data is not a valid RequestInit property, use .body instead","https://github.com/node-fetch/node-fetch/issues/1000 (request)");class z extends k{constructor(e,t={}){let o;if(x(e)?o=new URL(e.url):(o=new URL(e),e={}),o.username!==""||o.password!=="")throw new TypeError(`${o} is an url with embedded credentials.`);let n=t.method||e.method||"GET";if(/^(delete|get|head|options|post|put)$/i.test(n)&&(n=n.toUpperCase()),!x(t)&&"data"in t&&Te(),(t.body!=null||x(e)&&e.body!==null)&&(n==="GET"||n==="HEAD"))throw new TypeError("Request with GET/HEAD method cannot have body");const s=t.body?t.body:x(e)&&e.body!==null?K(e):null;super(s,{size:t.size||e.size||0});const a=new E(t.headers||e.headers||{});if(s!==null&&!a.has("Content-Type")){const i=Q(s);i&&a.set("Content-Type",i)}let u=x(e)?e.signal:null;if("signal"in t&&(u=t.signal),u!=null&&!se(u))throw new TypeError("Expected signal to be an instanceof AbortSignal or EventTarget");let f=t.referrer==null?e.referrer:t.referrer;if(f==="")f="no-referrer";else if(f){const i=new URL(f);f=/^about:(\/\/)?client$/.test(i)?"client":i}else f=void 0;this[l]={method:n,redirect:t.redirect||e.redirect||"follow",headers:a,parsedURL:o,signal:u,referrer:f},this.follow=t.follow===void 0?e.follow===void 0?20:e.follow:t.follow,this.compress=t.compress===void 0?e.compress===void 0?!0:e.compress:t.compress,this.counter=t.counter||e.counter||0,this.agent=t.agent||e.agent,this.highWaterMark=t.highWaterMark||e.highWaterMark||16384,this.insecureHTTPParser=t.insecureHTTPParser||e.insecureHTTPParser||!1,this.referrerPolicy=t.referrerPolicy||e.referrerPolicy||""}get method(){return this[l].method}get url(){return ne(this[l].parsedURL)}get headers(){return this[l].headers}get redirect(){return this[l].redirect}get signal(){return this[l].signal}get referrer(){if(this[l].referrer==="no-referrer")return"";if(this[l].referrer==="client")return"about:client";if(this[l].referrer)return this[l].referrer.toString()}get referrerPolicy(){return this[l].referrerPolicy}set referrerPolicy(e){this[l].referrerPolicy=ye(e)}clone(){return new z(this)}get[Symbol.toStringTag](){return"Request"}}Object.defineProperties(z.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0},signal:{enumerable:!0},referrer:{enumerable:!0},referrerPolicy:{enumerable:!0}});const Se=r=>{const{parsedURL:e}=r[l],t=new E(r[l].headers);t.has("Accept")||t.set("Accept","*/*");let o=null;if(r.body===null&&/^(post|put)$/i.test(r.method)&&(o="0"),r.body!==null){const u=fe(r);typeof u=="number"&&!Number.isNaN(u)&&(o=String(u))}o&&t.set("Content-Length",o),r.referrerPolicy===""&&(r.referrerPolicy=ge),r.referrer&&r.referrer!=="no-referrer"?r[l].referrer=we(r):r[l].referrer="no-referrer",r[l].referrer instanceof URL&&t.set("Referer",r.referrer),t.has("User-Agent")||t.set("User-Agent","node-fetch"),r.compress&&!t.has("Accept-Encoding")&&t.set("Accept-Encoding","gzip, deflate, br");let{agent:n}=r;typeof n=="function"&&(n=n(e)),!t.has("Connection")&&!n&&t.set("Connection","close");const s=pe(e),a={path:e.pathname+s,method:r.method,headers:t[Symbol.for("nodejs.util.inspect.custom")](),insecureHTTPParser:r.insecureHTTPParser,agent:n};return{parsedURL:e,options:a}};class Re extends D{constructor(e,t="aborted"){super(e,t)}}const Ee=new Set(["data:","http:","https:"]);async function Pe(r,e){return new Promise((t,o)=>{const n=new z(r,e),{parsedURL:s,options:a}=Se(n);if(!Ee.has(s.protocol))throw new TypeError(`node-fetch cannot load ${r}. URL scheme "${s.protocol.replace(/:$/,"")}" is not supported.`);const u=(s.protocol==="https:"?re:C).request,{signal:f}=n;let i=null;const J=()=>{const c=new Re("The operation was aborted.");o(c),n.body&&n.body instanceof S.Readable&&n.body.destroy(c),!(!i||!i.body)&&i.body.emit("error",c)};if(f&&f.aborted){J();return}const H=()=>{J(),L()},P=u(s.toString(),a);f&&f.addEventListener("abort",H);const L=()=>{P.abort(),f&&f.removeEventListener("abort",H)};P.on("error",c=>{o(new T(`request to ${n.url} failed, reason: ${c.message}`,"system",c)),L()}),Le(P,c=>{i&&i.body&&i.body.destroy(c)}),process.version<"v14"&&P.on("socket",c=>{let v;c.prependListener("end",()=>{v=c._eventsCount}),c.prependListener("close",h=>{if(i&&v<c._eventsCount&&!h){const R=new Error("Premature close");R.code="ERR_STREAM_PREMATURE_CLOSE",i.body.emit("error",R)}})}),P.on("response",c=>{P.setTimeout(0);const v=he(c.rawHeaders);if(X(c.statusCode)){const p=v.get("Location");let b=null;try{b=p===null?null:new URL(p,n.url)}catch{if(n.redirect!=="manual"){o(new T(`uri requested responds with an invalid redirect URL: ${p}`,"invalid-redirect")),L();return}}switch(n.redirect){case"error":o(new T(`uri requested responds with a redirect, redirect mode is set to error: ${n.url}`,"no-redirect")),L();return;case"manual":break;case"follow":{if(b===null)break;if(n.counter>=n.follow){o(new T(`maximum redirect reached at: ${n.url}`,"max-redirect")),L();return}const y={headers:new E(n.headers),follow:n.follow,counter:n.counter+1,agent:n.agent,compress:n.compress,method:n.method,body:K(n),signal:n.signal,size:n.size,referrer:n.referrer,referrerPolicy:n.referrerPolicy};if(!ie(n.url,b)||!ae(n.url,b))for(const ee of["authorization","www-authenticate","cookie","cookie2"])y.headers.delete(ee);if(c.statusCode!==303&&n.body&&e.body instanceof S.Readable){o(new T("Cannot follow redirect with body being a readable stream","unsupported-redirect")),L();return}(c.statusCode===303||(c.statusCode===301||c.statusCode===302)&&n.method==="POST")&&(y.method="GET",y.body=void 0,y.headers.delete("content-length"));const Y=be(v);Y&&(y.referrerPolicy=Y),t(Pe(new z(b,y))),L();return}default:return o(new TypeError(`Redirect option '${n.redirect}' is not a valid value of RequestRedirect`))}}f&&c.once("end",()=>{f.removeEventListener("abort",H)});let h=U(c,new N,p=>{p&&o(p)});process.version<"v12.10"&&c.on("aborted",H);const R={url:n.url,status:c.statusCode,statusText:c.statusMessage,headers:v,size:n.size,counter:n.counter,highWaterMark:n.highWaterMark},$=v.get("Content-Encoding");if(!n.compress||n.method==="HEAD"||$===null||c.statusCode===204||c.statusCode===304){i=new m(h,R),t(i);return}const q={flush:A.Z_SYNC_FLUSH,finishFlush:A.Z_SYNC_FLUSH};if($==="gzip"||$==="x-gzip"){h=U(h,A.createGunzip(q),p=>{p&&o(p)}),i=new m(h,R),t(i);return}if($==="deflate"||$==="x-deflate"){const p=U(c,new N,b=>{b&&o(b)});p.once("data",b=>{(b[0]&15)===8?h=U(h,A.createInflate(),y=>{y&&o(y)}):h=U(h,A.createInflateRaw(),y=>{y&&o(y)}),i=new m(h,R),t(i)}),p.once("end",()=>{i||(i=new m(h,R),t(i))});return}if($==="br"){h=U(h,A.createBrotliDecompress(),p=>{p&&o(p)}),i=new m(h,R),t(i);return}i=new m(h,R),t(i)}),le(P,n).catch(o)})}function Le(r,e){const t=d.from(`0\r
\r
`);let o=!1,n=!1,s;r.on("response",a=>{const{headers:u}=a;o=u["transfer-encoding"]==="chunked"&&!u["content-length"]}),r.on("socket",a=>{const u=()=>{if(o&&!n){const i=new Error("Premature close");i.code="ERR_STREAM_PREMATURE_CLOSE",e(i)}},f=i=>{n=d.compare(i.slice(-5),t)===0,!n&&s&&(n=d.compare(s.slice(-3),t.slice(0,3))===0&&d.compare(i.slice(-2),t.slice(3))===0),s=i};a.prependListener("close",u),a.on("data",f),r.on("close",()=>{a.removeListener("close",u),a.removeListener("data",f)})})}export{Re as AbortError,T as FetchError,E as Headers,z as Request,m as Response,Pe as default,X as isRedirect};
