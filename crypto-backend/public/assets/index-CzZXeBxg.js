import{g as E}from"./index-kZuNh3m-.js";import L from"net";import M from"tls";import I from"assert";import{r as T,a as B}from"./index-BveCBdm5.js";import q from"url";function U(_,O){for(var a=0;a<O.length;a++){const c=O[a];if(typeof c!="string"&&!Array.isArray(c)){for(const n in c)if(n!=="default"&&!(n in _)){const f=Object.getOwnPropertyDescriptor(c,n);f&&Object.defineProperty(_,n,f.get?f:{enumerable:!0,get:()=>c[n]})}}}return Object.freeze(Object.defineProperty(_,Symbol.toStringTag,{value:"Module"}))}var i={},v={},S;function z(){if(S)return v;S=1;var _=v&&v.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(v,"__esModule",{value:!0}),v.parseProxyResponse=void 0;const a=(0,_(T()).default)("https-proxy-agent:parse-proxy-response");function c(n){return new Promise((f,P)=>{let A=0;const H=[];function b(){const u=n.read();u?N(u):n.once("readable",b)}function C(){n.removeListener("end",p),n.removeListener("error",w),n.removeListener("readable",b)}function p(){C(),a("onend"),P(new Error("Proxy connection ended before receiving CONNECT response"))}function w(u){C(),a("onerror %o",u),P(u)}function N(u){H.push(u),A+=u.length;const m=Buffer.concat(H,A),e=m.indexOf(`\r
\r
`);if(e===-1){a("have not received end of HTTP headers yet..."),b();return}const r=m.slice(0,e).toString("ascii").split(`\r
`),t=r.shift();if(!t)return n.destroy(),P(new Error("No header received from proxy CONNECT response"));const o=t.split(" "),s=+o[1],d=o.slice(2).join(" "),l={};for(const h of r){if(!h)continue;const $=h.indexOf(":");if($===-1)return n.destroy(),P(new Error(`Invalid header from proxy CONNECT response: "${h}"`));const x=h.slice(0,$).toLowerCase(),R=h.slice($+1).trimStart(),g=l[x];typeof g=="string"?l[x]=[g,R]:Array.isArray(g)?g.push(R):l[x]=R}a("got proxy server response: %o %o",t,l),C(),f({connect:{statusCode:s,statusText:d,headers:l},buffered:m})}n.on("error",w),n.on("end",p),b()})}return v.parseProxyResponse=c,v}var D;function F(){if(D)return i;D=1;var _=i&&i.__createBinding||(Object.create?(function(e,r,t,o){o===void 0&&(o=t);var s=Object.getOwnPropertyDescriptor(r,t);(!s||("get"in s?!r.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,o,s)}):(function(e,r,t,o){o===void 0&&(o=t),e[o]=r[t]})),O=i&&i.__setModuleDefault||(Object.create?(function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}):function(e,r){e.default=r}),a=i&&i.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var t in e)t!=="default"&&Object.prototype.hasOwnProperty.call(e,t)&&_(r,e,t);return O(r,e),r},c=i&&i.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(i,"__esModule",{value:!0}),i.HttpsProxyAgent=void 0;const n=a(L),f=a(M),P=c(I),A=c(T()),H=B(),b=q,C=z(),p=(0,A.default)("https-proxy-agent"),w=e=>e.servername===void 0&&e.host&&!n.isIP(e.host)?{...e,servername:e.host}:e;class N extends H.Agent{constructor(r,t){super(t),this.options={path:void 0},this.proxy=typeof r=="string"?new b.URL(r):r,this.proxyHeaders=t?.headers??{},p("Creating new HttpsProxyAgent instance: %o",this.proxy.href);const o=(this.proxy.hostname||this.proxy.host).replace(/^\[|\]$/g,""),s=this.proxy.port?parseInt(this.proxy.port,10):this.proxy.protocol==="https:"?443:80;this.connectOpts={ALPNProtocols:["http/1.1"],...t?m(t,"headers"):null,host:o,port:s}}async connect(r,t){const{proxy:o}=this;if(!t.host)throw new TypeError('No "host" provided');let s;o.protocol==="https:"?(p("Creating `tls.Socket`: %o",this.connectOpts),s=f.connect(w(this.connectOpts))):(p("Creating `net.Socket`: %o",this.connectOpts),s=n.connect(this.connectOpts));const d=typeof this.proxyHeaders=="function"?this.proxyHeaders():{...this.proxyHeaders},l=n.isIPv6(t.host)?`[${t.host}]`:t.host;let h=`CONNECT ${l}:${t.port} HTTP/1.1\r
`;if(o.username||o.password){const y=`${decodeURIComponent(o.username)}:${decodeURIComponent(o.password)}`;d["Proxy-Authorization"]=`Basic ${Buffer.from(y).toString("base64")}`}d.Host=`${l}:${t.port}`,d["Proxy-Connection"]||(d["Proxy-Connection"]=this.keepAlive?"Keep-Alive":"close");for(const y of Object.keys(d))h+=`${y}: ${d[y]}\r
`;const $=(0,C.parseProxyResponse)(s);s.write(`${h}\r
`);const{connect:x,buffered:R}=await $;if(r.emit("proxyConnect",x),this.emit("proxyConnect",x,r),x.statusCode===200)return r.once("socket",u),t.secureEndpoint?(p("Upgrading socket connection to TLS"),f.connect({...m(w(t),"host","path","port"),socket:s})):s;s.destroy();const g=new n.Socket({writable:!1});return g.readable=!0,r.once("socket",y=>{p("Replaying proxy buffer for failed request"),(0,P.default)(y.listenerCount("data")>0),y.push(R),y.push(null)}),g}}N.protocols=["http","https"],i.HttpsProxyAgent=N;function u(e){e.resume()}function m(e,...r){const t={};let o;for(o in e)r.includes(o)||(t[o]=e[o]);return t}return i}var j=F();const K=E(j),Y=U({__proto__:null,default:K},[j]);export{Y as i};
